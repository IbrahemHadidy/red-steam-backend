{"version":3,"sources":["../../src/modules/app.module.ts"],"sourcesContent":["import path from 'path';\r\n\r\n// NestJS\r\nimport { Logger, MiddlewareConsumer, Module, NestModule, ValidationPipe } from '@nestjs/common';\r\nimport { ConfigModule, ConfigService } from '@nestjs/config';\r\nimport { APP_INTERCEPTOR, APP_PIPE } from '@nestjs/core';\r\n\r\n// Fastify plugins\r\nimport fastifyCookie from '@fastify/cookie';\r\nimport fastifyStatic from '@fastify/static';\r\n// import fastifyCsrf from '@fastify/csrf-protection';\r\nimport helmet from '@fastify/helmet';\r\nimport { fastifyMultipart } from '@fastify/multipart';\r\n// import fastifyRedis from '@fastify/redis';\r\n\r\n// Cache Manager\r\n// import { createKeyv } from '@keyv/redis';\r\n// import { CacheModule } from '@nestjs/cache-manager';\r\n// import { CacheableMemory } from 'cacheable';\r\n// import { Keyv } from 'keyv';\r\n\r\n// Global interceptors\r\nimport { ExceptionInterceptor } from '@interceptors/exception.interceptor';\r\n\r\n// Global Middlewares\r\nimport { LoggerMiddleware } from '@middlewares/logger.middleware';\r\n\r\n// Main Modules\r\nimport { ApisModule } from '@apis/apis.module';\r\nimport { RepositoriesModule } from '@repositories/repositories.module';\r\nimport { ServicesModule } from '@services/services.module';\r\n\r\n// Types\r\nimport type { NestFastifyApplication } from '@nestjs/platform-fastify';\r\n\r\n@Module({\r\n  imports: [\r\n    ConfigModule.forRoot({\r\n      isGlobal: true,\r\n      envFilePath: [\r\n        `src/common/configs/environments/.env.${process.env.NODE_ENV}.local`,\r\n        `src/common/configs/environments/.env.${process.env.NODE_ENV}`,\r\n        'src/common/configs/environments/.env',\r\n      ],\r\n    }),\r\n    // CacheModule.registerAsync({\r\n    //   imports: [ConfigModule],\r\n    //   inject: [ConfigService],\r\n    //   useFactory: (configService: ConfigService) => ({\r\n    //     stores: [\r\n    //       new Keyv({\r\n    //         store: new CacheableMemory({ ttl: configService.get<number>('CACHE_TTL') || 600, lruSize: 5000 }),\r\n    //       }),\r\n    //       createKeyv(configService.get<string>('REDIS_HOST')),\r\n    //     ],\r\n    //   }),\r\n    // }),\r\n    RepositoriesModule,\r\n    ServicesModule,\r\n    ApisModule,\r\n  ],\r\n  providers: [\r\n    // Use Exception Interceptor\r\n    {\r\n      provide: APP_INTERCEPTOR,\r\n      useClass: ExceptionInterceptor,\r\n    },\r\n    // Use Validation Pipe\r\n    {\r\n      provide: APP_PIPE,\r\n      useClass: ValidationPipe,\r\n      useValue: {\r\n        transform: true,\r\n        whitelist: true,\r\n        forbidNonWhitelisted: true,\r\n      },\r\n    },\r\n    Logger,\r\n  ],\r\n})\r\nexport class AppModule implements NestModule {\r\n  // This method used to register global middlewares on main.ts and e2e tests\r\n  static async register(app: NestFastifyApplication): Promise<NestFastifyApplication> {\r\n    const configService = app.get(ConfigService);\r\n\r\n    // Register Redis plugin for direct Redis interactions\r\n    // await app.register(fastifyRedis, {\r\n    //   host: configService.get<string>('REDIS_HOST'),\r\n    //   port: configService.get<number>('REDIS_PORT'),\r\n    //   password: configService.get<string>('REDIS_PASSWORD'),\r\n    // });\r\n\r\n    // Register fastify-static (to serve static files)\r\n    app.register(fastifyStatic, {\r\n      root: path.join(__dirname, 'public'),\r\n      prefix: '/public/',\r\n    });\r\n\r\n    // Register helmet (to set security headers)\r\n    await app.register(helmet);\r\n\r\n    // Register the multipart plugin (to handle file uploads)\r\n    await app.register(fastifyMultipart);\r\n\r\n    // Register fastify-cookie (to handle cookies)\r\n    await app.register(fastifyCookie, {\r\n      secret: configService.get<string>('COOKIE_SECRET'),\r\n      parseOptions: {},\r\n    });\r\n\r\n    // Register CSRF protection middleware\r\n    // await app.register(fastifyCsrf, {\r\n    //   cookieOpts: {\r\n    //     httpOnly: true,\r\n    //     secure: process.env.NODE_ENV === 'production',\r\n    //   },\r\n    // });\r\n\r\n    // Set global prefix for all routes\r\n    app.setGlobalPrefix('api');\r\n\r\n    // Configure CORS (to allow cross-origin requests)\r\n    app.enableCors({\r\n      origin: [process.env.FRONT_URL, process.env.BASE_URL],\r\n      methods: 'GET,HEAD,PUT,PATCH,POST,DELETE',\r\n      preflightContinue: false,\r\n      optionsSuccessStatus: 204,\r\n      credentials: true,\r\n      maxAge: 3600,\r\n    });\r\n\r\n    return app;\r\n  }\r\n\r\n  // Configure the logger middleware for all routes\r\n  public configure(consumer: MiddlewareConsumer) {\r\n    consumer.apply(LoggerMiddleware).forRoutes('*');\r\n  }\r\n}\r\n"],"names":["AppModule","register","app","configService","get","ConfigService","fastifyStatic","root","path","join","__dirname","prefix","helmet","fastifyMultipart","fastifyCookie","secret","parseOptions","setGlobalPrefix","enableCors","origin","process","env","FRONT_URL","BASE_URL","methods","preflightContinue","optionsSuccessStatus","credentials","maxAge","configure","consumer","apply","LoggerMiddleware","forRoutes","imports","ConfigModule","forRoot","isGlobal","envFilePath","NODE_ENV","RepositoriesModule","ServicesModule","ApisModule","providers","provide","APP_INTERCEPTOR","useClass","ExceptionInterceptor","APP_PIPE","ValidationPipe","useValue","transform","whitelist","forbidNonWhitelisted","Logger"],"mappings":";;;;+BAgFaA;;;eAAAA;;;6DAhFI;wBAG8D;wBACnC;sBACF;+DAGhB;+DACA;+DAEP;2BACc;sCAUI;kCAGJ;4BAGN;oCACQ;gCACJ;;;;;;;;;;;;AAkDxB,IAAA,AAAMA,YAAN,MAAMA;IACX,2EAA2E;IAC3E,aAAaC,SAASC,GAA2B,EAAmC;QAClF,MAAMC,gBAAgBD,IAAIE,GAAG,CAACC,qBAAa;QAE3C,sDAAsD;QACtD,qCAAqC;QACrC,mDAAmD;QACnD,mDAAmD;QACnD,2DAA2D;QAC3D,MAAM;QAEN,kDAAkD;QAClDH,IAAID,QAAQ,CAACK,eAAa,EAAE;YAC1BC,MAAMC,aAAI,CAACC,IAAI,CAACC,WAAW;YAC3BC,QAAQ;QACV;QAEA,4CAA4C;QAC5C,MAAMT,IAAID,QAAQ,CAACW,eAAM;QAEzB,yDAAyD;QACzD,MAAMV,IAAID,QAAQ,CAACY,2BAAgB;QAEnC,8CAA8C;QAC9C,MAAMX,IAAID,QAAQ,CAACa,eAAa,EAAE;YAChCC,QAAQZ,cAAcC,GAAG,CAAS;YAClCY,cAAc,CAAC;QACjB;QAEA,sCAAsC;QACtC,oCAAoC;QACpC,kBAAkB;QAClB,sBAAsB;QACtB,qDAAqD;QACrD,OAAO;QACP,MAAM;QAEN,mCAAmC;QACnCd,IAAIe,eAAe,CAAC;QAEpB,kDAAkD;QAClDf,IAAIgB,UAAU,CAAC;YACbC,QAAQ;gBAACC,QAAQC,GAAG,CAACC,SAAS;gBAAEF,QAAQC,GAAG,CAACE,QAAQ;aAAC;YACrDC,SAAS;YACTC,mBAAmB;YACnBC,sBAAsB;YACtBC,aAAa;YACbC,QAAQ;QACV;QAEA,OAAO1B;IACT;IAEA,iDAAiD;IAC1C2B,UAAUC,QAA4B,EAAE;QAC7CA,SAASC,KAAK,CAACC,kCAAgB,EAAEC,SAAS,CAAC;IAC7C;AACF;;;QAtGEC,SAAS;YACPC,oBAAY,CAACC,OAAO,CAAC;gBACnBC,UAAU;gBACVC,aAAa;oBACX,CAAC,qCAAqC,EAAElB,QAAQC,GAAG,CAACkB,QAAQ,CAAC,MAAM,CAAC;oBACpE,CAAC,qCAAqC,EAAEnB,QAAQC,GAAG,CAACkB,QAAQ,EAAE;oBAC9D;iBACD;YACH;YACA,8BAA8B;YAC9B,6BAA6B;YAC7B,6BAA6B;YAC7B,qDAAqD;YACrD,gBAAgB;YAChB,mBAAmB;YACnB,6GAA6G;YAC7G,YAAY;YACZ,6DAA6D;YAC7D,SAAS;YACT,QAAQ;YACR,MAAM;YACNC,sCAAkB;YAClBC,8BAAc;YACdC,sBAAU;SACX;QACDC,WAAW;YACT,4BAA4B;YAC5B;gBACEC,SAASC,qBAAe;gBACxBC,UAAUC,0CAAoB;YAChC;YACA,sBAAsB;YACtB;gBACEH,SAASI,cAAQ;gBACjBF,UAAUG,sBAAc;gBACxBC,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,sBAAsB;gBACxB;YACF;YACAC,cAAM;SACP"}